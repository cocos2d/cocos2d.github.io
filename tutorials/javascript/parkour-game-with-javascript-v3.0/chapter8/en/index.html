<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="The Cocos Team">
        <link rel="canonical" href="http://cocos2d-x.org/docs/tutorials/javascript/parkour-game-with-javascript-v3.0/chapter8/en/index.html">
        <link rel="shortcut icon" href="../../../../../img/favicon.ico">

	<title>_Chapter8 - Cocos Documentation</title>

  <link href="../../../../../css/bootstrap-custom.css" rel="stylesheet">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
<link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
<link href="../../../../../css/base.css" rel="stylesheet">
<link href="../../../../../css/cinder.css" rel="stylesheet">
<link href="../../../../../css/pg.css" rel="stylesheet">
<link href="../../../../../css/highlight.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-3216502-3', 'Cocos2d-x.org');
            ga('send', 'pageview');
        </script>
        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a style="padding: 12px 0px;" class="navbar-brand" href="../../../../../index.html">Documentation</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../../../../../index.html">Home</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Contents <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  
    <li class="dropdown-submenu">
      <a tabindex="-1" class="non-link">Manual Installations</a>
      <ul class="dropdown-menu">
          
              
  
  <li >
      <a href="../../../../../installation/A/index.html">Prerequisites</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../installation/Android-terminal/index.html">Android Command-line Setup</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../installation/Android-VisualStudio/index.html">Android Visual Studio Setup</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../installation/Android-Studio/index.html">Android Studio Setup</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../installation/Android-Eclipse/index.html">Android Eclipse Setup</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../installation/iOS/index.html">IOS and OSX Setup</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../installation/Linux/index.html">Linux Setup</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../installation/Tizen/index.html">Tizen Setup</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../installation/Windows/index.html">Windows Setup</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../installation/Windows-Phone/index.html">Windows Phone Setup</a>
  </li>
  

          
      </ul>
    </li>
  

                        
                            
  
    <li class="dropdown-submenu">
      <a tabindex="-1" class="non-link">Programmers Guide</a>
      <ul class="dropdown-menu">
          
              
  
  <li >
      <a href="../../../../../programmers-guide/about/index.html">About Cocos2d-x</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../programmers-guide/basic_concepts/index.html">Basic Concepts</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../programmers-guide/sprites/index.html">Sprites</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../programmers-guide/actions/index.html">Actions</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../programmers-guide/scenes/index.html">Scenes</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../programmers-guide/ui_components/index.html">UI</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../programmers-guide/other_node_types/index.html">Other Node Types</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../programmers-guide/event_dispatch/index.html">Event Dispatch</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../programmers-guide/3d/index.html">3D</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../programmers-guide/scripting/index.html">Scripting</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../programmers-guide/physics/index.html">Physics</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../programmers-guide/audio/index.html">Audio</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../programmers-guide/vr/index.html">VR</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../programmers-guide/advanced_topics/index.html">Advanced Topics</a>
  </li>
  

          
      </ul>
    </li>
  

                        
                            
  
    <li class="dropdown-submenu">
      <a tabindex="-1" class="non-link">Editors & Tools</a>
      <ul class="dropdown-menu">
          
              
  
  <li >
      <a href="../../../../../editors_and_tools/cocosCLTool/index.html">Command-line tool</a>
  </li>
  

          
              
  
  <li >
      <a href="../../../../../editors_and_tools/creator/index.html">Cocos Creator</a>
  </li>
  

          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
  
  <li >
      <a href="../../../../../editors_and_tools/cocos/index.html">Cocos Launcher</a>
  </li>
  

          
      </ul>
    </li>
  

                        
                            
  
    <li class="dropdown-submenu">
      <a tabindex="-1" class="non-link">Services</a>
      <ul class="dropdown-menu">
          
              
  
  <li >
      <a href="../../../../../services/sdkbox/index.html">SDKBOX</a>
  </li>
  

          
      </ul>
    </li>
  

                        
                            
  
    <li class="dropdown-submenu">
      <a tabindex="-1" class="non-link">Tutorials</a>
      <ul class="dropdown-menu">
          
              
  
  <li >
      <a href="../../../javascript/index.html">Parkour Game Tutorials for Cocos2d-JS</a>
  </li>
  

          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
      </ul>
    </li>
  

                        
                            
  
  <li >
      <a href="../../../../../api-ref/index.html">API Reference</a>
  </li>
  

                        
                            
  
    <li class="dropdown-submenu">
      <a tabindex="-1" class="non-link">Deprecated</a>
      <ul class="dropdown-menu">
          
              
  
  <li >
      <a href="../../../../../deprecated/studio/index.html">Cocos Studio</a>
  </li>
  

          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
      </ul>
    </li>
  

                        
                        </ul>
                    </li>
                
                

                <!-- new add for language button -->
                <!--<li>
                    <a href="http://sdkbox-doc.github.io/zh/">中文</a>
                </li>-->

                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                <!-- 
                    <li >
                        <a rel="next" href="../../chapter7/en/index.html">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../../chapter9/en/index.html">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                 -->
                
                    <li>
                        <a href="https://github.com/chukong/cocos-docs">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
              
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
      
        
          <li class="main active"><a href="#add-coin-and-obstacles-into-our-game">Add Coin and Obstacles Into Our Game</a></li>

          

              <!-- slackmoehrle 2/1/2016 - added this so we can build docs but not be in menus -->
              
                <li><a href="#introduction">Introduction</a></li>
              

          

              <!-- slackmoehrle 2/1/2016 - added this so we can build docs but not be in menus -->
              
                <li><a href="#preparation">Preparation</a></li>
              

          

              <!-- slackmoehrle 2/1/2016 - added this so we can build docs but not be in menus -->
              
                <li><a href="#introduction-to-tiledmap-object-layer">Introduction to TiledMap Object Layer</a></li>
              

          

              <!-- slackmoehrle 2/1/2016 - added this so we can build docs but not be in menus -->
              
                <li><a href="#refactor-backgroundlayer-class-and-add-some-helper-method">Refactor BackgroundLayer Class and Add Some Helper Method</a></li>
              

          

              <!-- slackmoehrle 2/1/2016 - added this so we can build docs but not be in menus -->
              
                <li><a href="#add-coin-and-rock">Add Coin and Rock</a></li>
              

          

              <!-- slackmoehrle 2/1/2016 - added this so we can build docs but not be in menus -->
              
                <li><a href="#improve-the-playscene">Improve the PlayScene</a></li>
              

          

              <!-- slackmoehrle 2/1/2016 - added this so we can build docs but not be in menus -->
              
                <li><a href="#wrap-all-these-things-up">Wrap all these things up</a></li>
              

          

              <!-- slackmoehrle 2/1/2016 - added this so we can build docs but not be in menus -->
              
                <li><a href="#summary">Summary</a></li>
              

          

              <!-- slackmoehrle 2/1/2016 - added this so we can build docs but not be in menus -->
              
                <li><a href="#where-to-go-from-here">Where to go from here?</a></li>
              

          

        
      
    
    </ul>
</div></div>
              
                <div class="col-md-9" role="main">

<!-- bread crumb trail -->
<ol class="breadcrumb">
<li><a href="../../../../../index.html">Docs</a></li>

  
    
      <li>Contents</li>
    
  
    
      <li>Tutorials</li>
    
  

<li>_Chapter8</li>
</ol>

<!-- previous/next buttons for everything but the home page -->

<ul class="nav navbar-nav navbar-right">
    
        <li >
            <a rel="next" href="../../chapter7/en/index.html">
                <i class="fa fa-arrow-left"></i> Previous
            </a>
        </li>
        <li >
            <a rel="prev" href="../../chapter9/en/index.html">
                Next <i class="fa fa-arrow-right"></i>
            </a>
        </li>
    
</ul>


<!-- we can put this here if we want it on all content pages, but we don't at this point -->
<!--<div class="langs">
  <ul>
    <li><a href="#" id="tab-cpp">C++</a></li>
    <li><a href="#" id="tab-js">Javascript</a></li>-->
    <!--<li><a href="#" id="tab-lua">Lua</a></li>-->
  <!--</ul>
</div>-->

<h1 id="add-coin-and-obstacles-into-our-game">Add Coin and Obstacles Into Our Game</h1>
<h2 id="introduction">Introduction</h2>
<p>In this tutorial, we will try to add Coin and Obstacles into our parkour game.</p>
<p>After this tutorial, our player should be able to collect the coin when he is running and he will die when he collides with the obstacle.</p>
<p>We will also cover how to design a game level with tiled map editor. Since the game logic is a little bit complex than before,
so we will refactor the code before we adding new game components.</p>
<h2 id="preparation">Preparation</h2>
<p>Before we start, let's finish the preparation stuff.</p>
<h3 id="setup-resource-and-globals">Setup Resource and Globals</h3>
<p>Since we will add two more game elements into our parkour game. So we need add some more global integer tags to identify each game items.</p>
<p>Let's add the following code snippets at the end of <em>globals.js</em>:</p>
<pre><code>// collision type for chipmunk
if(typeof SpriteTag == &quot;undefined&quot;) {
    var SpriteTag = {};
    SpriteTag.runner = 0;
    SpriteTag.coin = 1;
    SpriteTag.rock = 2;
};
</code></pre>

<p>Here we use 0,1,2 to represent runner,coin and rock.</p>
<p>We also introduce another spritesheet named <em>background.png</em> and <em>background.plist</em>. We have packed the coins and rocks sprites into the spritesheet named background.png.</p>
<p>The details of how to pack these sprites are leave out for the next subsection.</p>
<p>Next, let's copy the resource files into our <em>res</em> directory and add two more variables for further referring.</p>
<pre><code>var res = {
    helloBG_png : &quot;res/helloBG.png&quot;,
    start_n_png : &quot;res/start_n.png&quot;,
    start_s_png : &quot;res/start_s.png&quot;,
    PlayBG_png  : &quot;res/PlayBG.png&quot;,
    runner_png  : &quot;res/running.png&quot;,
    runner_plist : &quot;res/running.plist&quot;,
    map_png : &quot;res/map.png&quot;,
    map00_tmx : &quot;res/map00.tmx&quot;,
    map01_tmx : &quot;res/map01.tmx&quot;,
    background_png :&quot;res/background.png&quot;,
    background_plist : &quot;res/background.plist&quot;
};

var g_resources = [
    //image
    res.helloBG_png,
    res.start_n_png,
    res.start_s_png,
    res.PlayBG_png,
    res.runner_png,
    res.runner_plist,
    res.map_png,
    res.map00_tmx,
    res.map01_tmx,
    res.background_png,
    res.background_plist
];
</code></pre>

<h3 id="pack-coins-and-rocks-into-spritesheet-with-texturepacker">Pack Coins and Rocks into Spritesheet with TexturePacker</h3>
<p>In the previous chapter, we have learned how to pack a bunch of small sprites into a big large compact spritesheet. Let's pack another spritesheet.</p>
<p>At first, you should launch TexturePacker and drag all the assets under <em>res/TexturePacker/coins and rocks</em> director.(Note: You can get the whole game resource from the download as before.)</p>
<p>After dragging the resource, you should specify the <em>Data file</em> and <em>Texture format</em> with some path like <em>xxx/chapter8/res/background.png</em> or <em>xxx/chapter8/res/background.plist</em>.</p>
<p>If you don't want to any optimization of the spritesheet, just leave them out and press <em>Publish</em> to generate the final spritesheet.</p>
<p><img alt="packcoins" src="../res/packcoins.png" /></p>
<h2 id="introduction-to-tiledmap-object-layer">Introduction to TiledMap Object Layer</h2>
<p>We have used TiledMap for our level map, but it lacks game items. So in this section, we will cover how to design level items with TiledMap object layer.</p>
<h3 id="add-coin-object-layer">Add Coin Object Layer</h3>
<p>At first, we'll add Coin object layer.</p>
<ol>
<li>
<p>Launch Tiled and open <em>map00.tmx</em> and <em>map01.tmx</em>.</p>
</li>
<li>
<p>Create an Object layer named <em>coin</em> in map00.tmx and map01.tmx.
<img alt="objectlayer" src="../res/objectlayer.png" /></p>
</li>
<li>
<p>Design object layer by dragging and dropping rectangle object into the map.
You can change the rectangle size and it's position. You can also duplicate or delete the objects.</p>
</li>
</ol>
<p><img alt="designobjectlayer" src="../res/designobjectlayer.png" /></p>
<ol>
<li>Some tips on designing object layer:
You can change opacity of the layers in the tiled map so that you can easily place the object.</li>
</ol>
<h3 id="add-rock-object-layer">Add Rock Object Layer</h3>
<p>The process to create the Rock object layer is more or less the same as creating coin object layer.</p>
<p>So we will leave it out for your own implementation.</p>
<h2 id="refactor-backgroundlayer-class-and-add-some-helper-method">Refactor BackgroundLayer Class and Add Some Helper Method</h2>
<p>Sometimes, when you are coding, you may find that it is extremely hard to add new functionality into the existing structure.</p>
<p>It is a bad code smell and we should stop and do refactor work right now.</p>
<h3 id="refactor-backgroundlayer-class">Refactor BackgroundLayer Class</h3>
<p>Since we will add Chipmunk physic body into our background, so we need a method to obtain the <em>space</em> object created in <em>PlayScene</em>.</p>
<p>Let's change the name of <em>ctor</em> function in Background Layer and pass a parameter named <em>space</em> into it. We should also add a new member variable into the
BackgroundLayer class. Here is the code snippets:</p>
<pre><code>    ctor:function (space) {
        this._super();

        // clean old array here
        this.objects = [];
        this.space = space;

        this.init();
    },
</code></pre>

<p>Here we have added additional init code. We added a array named <em>objects</em> and initialize it to an empty array.</p>
<p>(<em>Note: You should call this.init() method right after the assignment of this.space = space. Because we will create physic objects in the init method</em>)</p>
<h3 id="add-helper-method">Add Helper Method</h3>
<ol>
<li>Add more member variables into BackgroundLayer class:</li>
</ol>
<pre><code>    space:null,
    spriteSheet:null,
    objects:[],
</code></pre>

<ol>
<li>Initialize spritesheet in the <em>init</em> method:</li>
</ol>
<pre><code>    // create sprite sheet
        cc.spriteFrameCache.addSpriteFrames(res.background_plist);
        this.spriteSheet = new cc.SpriteBatchNode(res.background_png);
        this.addChild(this.spriteSheet);
</code></pre>

<ol>
<li>Add a method named <em>loadObject</em> to initialize rock and coins.</li>
</ol>
<pre><code> loadObjects:function (map, mapIndex) {
        // add coins
        var coinGroup = map.getObjectGroup(&quot;coin&quot;);
        var coinArray = coinGroup.getObjects();
        for (var i = 0; i &lt; coinArray.length; i++) {
            var coin = new Coin(this.spriteSheet,
                this.space,
                cc.p(coinArray[i][&quot;x&quot;] + this.mapWidth * mapIndex,coinArray[i][&quot;y&quot;]));
            coin.mapIndex = mapIndex;
            this.objects.push(coin);
        }

        // add rock
        var rockGroup = map.getObjectGroup(&quot;rock&quot;);
        var rockArray = rockGroup.getObjects();
        for (var i = 0; i &lt; rockArray.length; i++) {
            var rock = new Rock(this.spriteSheet,
                this.space,
                rockArray[i][&quot;x&quot;] + this.mapWidth * mapIndex);
            rock.mapIndex = mapIndex;
            this.objects.push(rock);
        }
    },
</code></pre>

<p>Here we iterate all the objects info in the tiled map and create responding Chipmunk rigid bodies. Finally we store these object into the <em>objects</em> array.</p>
<p>All these code are self-explanation. You should only pay attention to the <em>mapIndex</em> parameter. We use the parameter to calculate where we should place the rigid body.</p>
<p>We need call <em>loadObject</em> method at the end of <em>init</em> method to create the  physic objects in the first two screen maps.</p>
<pre><code>this.loadObjects(this.map00, 0);
this.loadObjects(this.map01, 1);
</code></pre>

<ol>
<li>Add another two helper methods for removing unused chipmunk rigid bodies.</li>
</ol>
<p>The first method is called <em>removeObjects</em>. It removes a object by <em>mapIndex</em>. Here is the implementation:</p>
<pre><code>removeObjects:function (mapIndex) {
        while((function (obj, index) {
            for (var i = 0; i &lt; obj.length; i++) {
                if (obj[i].mapIndex == index) {
                    obj[i].removeFromParent();
                    obj.splice(i, 1);
                    return true;
                }
            }
            return false;
        })(this.objects, mapIndex));
    },
</code></pre>

<p>The other method is called <em>removeObjectByShape</em>:</p>
<pre><code>   removeObjectByShape:function (shape) {
        for (var i = 0; i &lt; this.objects.length; i++) {
            if (this.objects[i].getShape() == shape) {
                this.objects[i].removeFromParent();
                this.objects.splice(i, 1);
                break;
            }
        }
    },
</code></pre>

<p>This method will remove a chipmunk object by its shape.</p>
<h3 id="wrap-it-up-add-creation-and-disposable-logic-in-checkandreload-method">Wrap it up: Add Creation and Disposable Logic in checkAndReload Method</h3>
<p>When the map is moved, we should also call <em>loadObject</em> method to recreate the "Coins &amp; Rocks".</p>
<p>And also we sould remove all unused objects by calling <em>removeObjects</em> method.</p>
<p>Here is the code snippets:</p>
<pre><code>  checkAndReload:function (eyeX) {
        var newMapIndex = parseInt(eyeX / this.mapWidth);
        if (this.mapIndex == newMapIndex) {
            return false;
        }

        if (0 == newMapIndex % 2) {
            // change mapSecond
            this.map01.setPositionX(this.mapWidth * (newMapIndex + 1));
            this.loadObjects(this.map01, newMapIndex + 1);
        } else {
            // change mapFirst
            this.map00.setPositionX(this.mapWidth * (newMapIndex + 1));
            this.loadObjects(this.map00, newMapIndex + 1);
        }
        this.removeObjects(newMapIndex - 1);
        this.mapIndex = newMapIndex;

        return true;
    },
</code></pre>

<h2 id="add-coin-and-rock">Add Coin and Rock</h2>
<p>Now it's time to add the coin and rock implementation. Despite the implementation details, you should also pay attention to the design idea behind these two
classes. Here we prefer to inherit from cc.Class instead of cc.Sprite. We let each object to own a instance of cc.Sprite.</p>
<h3 id="design-and-implement-coin-class">Design and Implement Coin Class</h3>
<ol>
<li>
<p>Create a new file named <em>coin.js</em>. We will define our Coin class in this file. Make sure you have this filed located in your <em>src</em> directory.</p>
</li>
<li>
<p>Derived a class named <em>Coin</em> from cc.Class, let's take a look at the whole implementation:</p>
</li>
</ol>
<pre><code>var Coin = cc.Class.extend({
    space:null,
    sprite:null,
    shape:null,
    _mapIndex:0,// which map belongs to
    get mapIndex() {
        return this._mapIndex;
    },
    set mapIndex(index) {
        this._mapIndex = index;
    },

    /** Constructor
     * @param {cc.SpriteBatchNode *}
     * @param {cp.Space *}
     * @param {cc.p}
     */
    ctor:function (spriteSheet, space, pos) {
        this.space = space;

        // init coin animation
        var animFrames = [];
        for (var i = 0; i &lt; 8; i++) {
            var str = &quot;coin&quot; + i + &quot;.png&quot;;
            var frame = cc.spriteFrameCache.getSpriteFrame(str);
            animFrames.push(frame);
        }

        var animation = new cc.Animation(animFrames, 0.2);
        var action = new cc.RepeatForever(new cc.Animate(animation));

        this.sprite = new cc.PhysicsSprite(&quot;#coin0.png&quot;);

        // init physics
        var radius = 0.95 * this.sprite.getContentSize().width / 2;
        var body = new cp.StaticBody();
        body.setPos(pos);
        this.sprite.setBody(body);

        this.shape = new cp.CircleShape(body, radius, cp.vzero);
        this.shape.setCollisionType(SpriteTag.coin);
        //Sensors only call collision callbacks, and never generate real collisions
        this.shape.setSensor(true);

        this.space.addStaticShape(this.shape);

        // add sprite to sprite sheet
        this.sprite.runAction(action);
        spriteSheet.addChild(this.sprite, 1);
    },

    removeFromParent:function () {
        this.space.removeStaticShape(this.shape);
        this.shape = null;
        this.sprite.removeFromParent();
        this.sprite = null;
    },

    getShape:function () {
        return this.shape;
    }
});
</code></pre>

<p>Let's explain the code piece by piece.</p>
<p>At first, we add three member variables named: <em>space</em>, <em>sprite</em> and <em>shape</em>. We will use these variables to create the coin object's physic body
and its display attribution.</p>
<p>Then, we added another member variable <em>_mapIndex</em>.  We used the <em>get/set</em> syntax sugar to define accessor of the variable.</p>
<p>The <em>ctor</em> method is the constructor of Coin class. We will create a Coin class with a spritesheet, a space and a position object later.</p>
<p>Since the coins are circular shape, so we have created CircleShape attached to the rigid body. The remaining part of the ctor function is self-explanation.</p>
<p>At last, we need to define a method to do the cleanup work. It's the <em>removeFromParent</em> method. It firstly remove the rigid body from the space and then remove the sprite
from its parent. The <em>getShape</em> method is just a getter method used for accessing the shape object stored in the coin object.</p>
<h3 id="design-and-implement-rock-class">Design and Implement Rock Class</h3>
<p>The principle of designing the Rock class is more or less as the Coin class except for the rigid shape type part.</p>
<p>Because our Rock class is a rectangle box. So we use cp.BoxShape to replace the cc.CircleShape in Coin class.</p>
<p>Here is the full source code of rock.js:</p>
<pre><code>var Rock = cc.Class.extend({
    space:null,
    sprite:null,
    shape:null,
    _map:0,// which map belong to
    get map() {
        return this._map;
    },
    set map(newMap) {
        this._map = newMap;
    },

    /** Constructor
     * @param {cc.SpriteBatchNode *}
     * @param {cp.Space *}
     * @param {cc.p}
     */
    ctor:function (spriteSheet, space, posX) {
        this.space = space;

        this.sprite = new cc.PhysicsSprite(&quot;#rock.png&quot;);
        var body = new cp.StaticBody();
        body.setPos(cc.p(posX, this.sprite.getContentSize().height / 2 + g_groundHeight));
        this.sprite.setBody(body);

        this.shape = new cp.BoxShape(body,
            this.sprite.getContentSize().width,
            this.sprite.getContentSize().height);
        this.shape.setCollisionType(SpriteTag.rock);

        this.space.addStaticShape(this.shape);
        spriteSheet.addChild(this.sprite);
    },

    removeFromParent:function () {
        this.space.removeStaticShape(this.shape);
        this.shape = null;
        this.sprite.removeFromParent();
        this.sprite = null;
    },

    getShape:function () {
        return this.shape;
    }
});
</code></pre>

<h2 id="improve-the-playscene">Improve the PlayScene</h2>
<h3 id="refactor-onenter-function-of-playscene">Refactor onEnter function of PlayScene</h3>
<ol>
<li>At first, let's add a extra array named <em>shapesToRemove</em> and initialize it at the beginning of <em>onEnter</em> function in PlayScene.js.</li>
</ol>
<pre><code>//the following line goes in init member variable define area
shapesToRemove :[],

//the following line goes at the beginning of the *onEnter* function.
this.shapesToRemove = [];
</code></pre>

<ol>
<li>Secondly, modify the creation of BackgroundLayer. Here we simply pass the space object into BackgroundLayer's constructor.</li>
</ol>
<pre><code>    this.gameLayer.addChild(new BackgroundLayer(this.space), 0, TagOfLayer.background);
</code></pre>

<h3 id="add-collision-detection-callbacks">Add Collision Detection Callbacks</h3>
<ul>
<li>At first, we should call these two functions at the end of <em>initPhyiscs</em> method:</li>
</ul>
<pre><code> // setup chipmunk CollisionHandler
        this.space.addCollisionHandler(SpriteTag.runner, SpriteTag.coin,
            this.collisionCoinBegin.bind(this), null, null, null);
        this.space.addCollisionHandler(SpriteTag.runner, SpriteTag.rock,
            this.collisionRockBegin.bind(this), null, null, null);
</code></pre>

<p>The <em>addCollisionHandler</em> method needs a callback when collision occurs.</p>
<ul>
<li>Then, let's define these two callbacks to handle player collide with coins and rocks.</li>
</ul>
<pre><code> collisionCoinBegin:function (arbiter, space) {
        var shapes = arbiter.getShapes();
        // shapes[0] is runner
        this.shapesToRemove.push(shapes[1]);
    },

    collisionRockBegin:function (arbiter, space) {
        cc.log(&quot;==game over&quot;);
    },
</code></pre>

<ul>
<li>Delete unused rigid bodies in background layer. You should add the following code at the end of <em>update</em> method:</li>
</ul>
<pre><code>        // Simulation cpSpaceAddPostStepCallback
        for(var i = 0; i &lt; this.shapesToRemove.length; i++) {
            var shape = this.shapesToRemove[i];
            this.gameLayer.getChildByTag(TagOfLayer.background).removeObjectByShape(shape);
        }
        this.shapesToRemove = [];
</code></pre>

<p>We can't delete physic bodies during the physic simulation process. so we use an extra array named <em>shapesToRemove</em> to hold the temporal data needed to be deleted.</p>
<h2 id="wrap-all-these-things-up">Wrap all these things up</h2>
<p>Congratulations! You almost reach the end. Before we hit the <em>debug</em> button to see the results. Let's add some extra glue code to connect everything together.</p>
<p>Open <em>project.json</em> and append two more array items at the end of <em>jsList</em> array.</p>
<pre><code>    &quot;jsList&quot; : [
        &quot;src/resource.js&quot;,
        &quot;src/app.js&quot;,
        &quot;src/AnimationLayer.js&quot;,
        &quot;src/BackgroundLayer.js&quot;,
        &quot;src/PlayScene.js&quot;,
        &quot;src/StatusLayer.js&quot;,
        &quot;src/globals.js&quot;,
        &quot;src/coin.js&quot;,
        &quot;src/rock.js&quot;
    ]
</code></pre>

<p>Build and run! Cheers, we did it!:)</p>
<p>Let's see our final fruits:</p>
<p><img alt="fruit" src="../res/result.png" /></p>
<h2 id="summary">Summary</h2>
<p>In this tutorial, we have enjoyed a very long journey. But worth it, isn't it?</p>
<p>We have learned how to use TiledMap's object layer to design complex game levels and how to customize your own class to extend your code structure.</p>
<p>You can download the full source code from <a href="../res/Parkour.zip">here</a>.</p>
<h2 id="where-to-go-from-here">Where to go from here?</h2>
<p>In the next tutorial, we'll cover how to update game HUD constantly and we'll also add game over logic and simple gesture recognizer into our game to make the
player to jump over the obstacles. Keep tuning!</p>

<!-- previous/next buttons for everything but the home page -->

<ul class="nav navbar-nav navbar-right">
    
        <li >
            <a rel="next" href="../../chapter7/en/index.html">
                <i class="fa fa-arrow-left"></i> Previous
            </a>
        </li>
        <li >
            <a rel="prev" href="../../chapter9/en/index.html">
                Next <i class="fa fa-arrow-right"></i>
            </a>
        </li>
    
</ul>
</div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
                <p style="text-align:center">Copyright (c) 2014-2016 Chukong Technologies Inc.</p>
            
           <!-- <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>-->
        </footer>

        <script src="../../../../../js/jquery-1.10.2.min.js"></script>
        <script src="../../../../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../../../../js/highlight.pack.js"></script>
        <script>var base_url = '../../../../..';</script>

        <!-- PG languages -->
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
        <script>
        $(function() {
          var key = "Cocos2d-x_pg_lang";
          var switch_lang = function(l) {
              $('.langs li a').removeClass('selected');
              $('#'+l).addClass('selected');
              $('.tab_content').hide();
              $('.'+l).show();
              $.cookie(key, l);
          }
          $('.langs li a').click(function() {switch_lang(this.id);return false;});
          var c = $.cookie(key);
          if (typeof c == 'undefined') c='tab-cpp';
          switch_lang(c);
        });
        </script>

        <script data-main="../../../../../mkdocs/js/search.js" src="../../../../../mkdocs/js/require.js"></script>
        <script src="../../../../../js/base.js"></script>
        <script src="../../../../../tutorials/javascript/parkour-game-with-javascript/Cocos2d-html5-min.js"></script>
        <script src="../../../../../tutorials/javascript/parkour-game-with-javascript/chipmunk.js"></script>
        <script src="../../../../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/cocos2d-jsb.js"></script>
        <script src="../../../../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/cocos2d.js"></script>
        <script src="../../../../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/main.js"></script>
        <script src="../../../../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/AnimationLayer.js"></script>
        <script src="../../../../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/BackgroundLayer.js"></script>
        <script src="../../../../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/Coin.js"></script>
        <script src="../../../../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/GameOverLayer.js"></script>
        <script src="../../../../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/PlayScene.js"></script>
        <script src="../../../../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/Rock.js"></script>
        <script src="../../../../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/SimpleRecognizer.js"></script>
        <script src="../../../../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/StatusLayer.js"></script>
        <script src="../../../../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/globals.js"></script>
        <script src="../../../../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/myApp.js"></script>
        <script src="../../../../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/resource.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
