<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="The Cocos Team">
        <link rel="canonical" href="http://cocos2d-x.org/docs/programmers-guide/scripting/index.html">
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Scripting - Cocos Documentation</title>

  <link href="../../css/bootstrap-custom.css" rel="stylesheet">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
<link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
<link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
<link href="../../css/base.css" rel="stylesheet">
<link href="../../css/cinder.css" rel="stylesheet">
<link href="../../css/pg.css" rel="stylesheet">
<link href="../../css/highlight.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-3216502-3', 'Cocos2d-x.org');
            ga('send', 'pageview');
        </script>
        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a style="padding: 12px 0px;" class="navbar-brand" href="../../index.html">Documentation</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../../index.html">Home</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Contents <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  
    <li class="dropdown-submenu">
      <a tabindex="-1" class="non-link">Manual Installations</a>
      <ul class="dropdown-menu">
          
              
  
  <li >
      <a href="../../installation/A/index.html">Prerequisites</a>
  </li>
  

          
              
  
  <li >
      <a href="../../installation/Android-terminal/index.html">Android Command-line Setup</a>
  </li>
  

          
              
  
  <li >
      <a href="../../installation/Android-VisualStudio/index.html">Android Visual Studio Setup</a>
  </li>
  

          
              
  
  <li >
      <a href="../../installation/Android-Studio/index.html">Android Studio Setup</a>
  </li>
  

          
              
  
  <li >
      <a href="../../installation/Android-Eclipse/index.html">Android Eclipse Setup</a>
  </li>
  

          
              
  
  <li >
      <a href="../../installation/iOS/index.html">IOS and OSX Setup</a>
  </li>
  

          
              
  
  <li >
      <a href="../../installation/Linux/index.html">Linux Setup</a>
  </li>
  

          
              
  
  <li >
      <a href="../../installation/Tizen/index.html">Tizen Setup</a>
  </li>
  

          
              
  
  <li >
      <a href="../../installation/Windows/index.html">Windows Setup</a>
  </li>
  

          
              
  
  <li >
      <a href="../../installation/Windows-Phone/index.html">Windows Phone Setup</a>
  </li>
  

          
      </ul>
    </li>
  

                        
                            
  
    <li class="dropdown-submenu">
      <a tabindex="-1" class="non-link">Programmers Guide</a>
      <ul class="dropdown-menu">
          
              
  
  <li >
      <a href="../about/index.html">About Cocos2d-x</a>
  </li>
  

          
              
  
  <li >
      <a href="../basic_concepts/index.html">Basic Concepts</a>
  </li>
  

          
              
  
  <li >
      <a href="../sprites/index.html">Sprites</a>
  </li>
  

          
              
  
  <li >
      <a href="../actions/index.html">Actions</a>
  </li>
  

          
              
  
  <li >
      <a href="../scenes/index.html">Scenes</a>
  </li>
  

          
              
  
  <li >
      <a href="../ui_components/index.html">UI</a>
  </li>
  

          
              
  
  <li >
      <a href="../other_node_types/index.html">Other Node Types</a>
  </li>
  

          
              
  
  <li >
      <a href="../event_dispatch/index.html">Event Dispatch</a>
  </li>
  

          
              
  
  <li >
      <a href="../3d/index.html">3D</a>
  </li>
  

          
              
  
  <li class="active">
      <a href="index.html">Scripting</a>
  </li>
  

          
              
  
  <li >
      <a href="../physics/index.html">Physics</a>
  </li>
  

          
              
  
  <li >
      <a href="../audio/index.html">Audio</a>
  </li>
  

          
              
  
  <li >
      <a href="../vr/index.html">VR</a>
  </li>
  

          
              
  
  <li >
      <a href="../advanced_topics/index.html">Advanced Topics</a>
  </li>
  

          
      </ul>
    </li>
  

                        
                            
  
    <li class="dropdown-submenu">
      <a tabindex="-1" class="non-link">Editors & Tools</a>
      <ul class="dropdown-menu">
          
              
  
  <li >
      <a href="../../editors_and_tools/cocosCLTool/index.html">Command-line tool</a>
  </li>
  

          
              
  
  <li >
      <a href="../../editors_and_tools/creator/index.html">Cocos Creator</a>
  </li>
  

          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
  
  <li >
      <a href="../../editors_and_tools/cocos/index.html">Cocos Launcher</a>
  </li>
  

          
      </ul>
    </li>
  

                        
                            
  
    <li class="dropdown-submenu">
      <a tabindex="-1" class="non-link">Services</a>
      <ul class="dropdown-menu">
          
              
  
  <li >
      <a href="../../services/sdkbox/index.html">SDKBOX</a>
  </li>
  

          
      </ul>
    </li>
  

                        
                            
  
    <li class="dropdown-submenu">
      <a tabindex="-1" class="non-link">Tutorials</a>
      <ul class="dropdown-menu">
          
              
  
  <li >
      <a href="../../tutorials/javascript/javascript/index.html">Parkour Game Tutorials for Cocos2d-JS</a>
  </li>
  

          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
      </ul>
    </li>
  

                        
                            
  
  <li >
      <a href="../../api-ref/index.html">API Reference</a>
  </li>
  

                        
                            
  
    <li class="dropdown-submenu">
      <a tabindex="-1" class="non-link">Deprecated</a>
      <ul class="dropdown-menu">
          
              
  
  <li >
      <a href="../../deprecated/studio/index.html">Cocos Studio</a>
  </li>
  

          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
              
          
      </ul>
    </li>
  

                        
                        </ul>
                    </li>
                
                

                <!-- new add for language button -->
                <!--<li>
                    <a href="http://sdkbox-doc.github.io/zh/">中文</a>
                </li>-->

                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                <!-- 
                    <li >
                        <a rel="next" href="../3d/index.html">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../physics/index.html">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                 -->
                
                    <li>
                        <a href="https://github.com/chukong/cocos-docs">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
              
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
      
        
          <li class="main active"><a href="#scripting">Scripting</a></li>

          

              <!-- slackmoehrle 2/1/2016 - added this so we can build docs but not be in menus -->
              
                <li><a href="#script-component">Script component</a></li>
              

          

        
      
    
    </ul>
</div></div>
              
                <div class="col-md-9" role="main">

<!-- bread crumb trail -->
<ol class="breadcrumb">
<li><a href="../../index.html">Docs</a></li>

  
    
      <li>Contents</li>
    
  
    
      <li>Programmers Guide</li>
    
  

<li>Scripting</li>
</ol>

<!-- previous/next buttons for everything but the home page -->

<ul class="nav navbar-nav navbar-right">
    
        <li >
            <a rel="next" href="../3d/index.html">
                <i class="fa fa-arrow-left"></i> Previous
            </a>
        </li>
        <li >
            <a rel="prev" href="../physics/index.html">
                Next <i class="fa fa-arrow-right"></i>
            </a>
        </li>
    
</ul>


<!-- we can put this here if we want it on all content pages, but we don't at this point -->
<!--<div class="langs">
  <ul>
    <li><a href="#" id="tab-cpp">C++</a></li>
    <li><a href="#" id="tab-js">Javascript</a></li>-->
    <!--<li><a href="#" id="tab-lua">Lua</a></li>-->
  <!--</ul>
</div>-->

<h1 id="scripting">Scripting</h1>
<h2 id="script-component">Script component</h2>
<p><strong>Script component</strong> is used to extend c++ <code>Node</code> objects. You can add a
<strong>script component</strong> to a <code>Node</code>, then the <strong>script component</strong> will receive
<strong>onEnter</strong>, <strong>onExit</strong> and <strong>update</strong> events.</p>
<p><strong>Script component</strong> supports both JavaScript and LUA. You should use the proper
<strong>script component</strong> type for the language you are developing with. If you are
developing with JavaScript, you would use <code>ComponentJS</code>, if you are developing
with Lua, you would use <code>ComponentLUA</code>. But, you cannot mix them or use them in
a c++ project! This is because the proper bindings for that language are required
and these bindings are only available in their respective project types.</p>
<p>Example with Lua:</p>
<pre><code class="cpp">// create a Sprite and add a LUA component
auto player = Sprite::create(&quot;player.png&quot;);

auto luaComponent = ComponentLua::create(&quot;player.lua&quot;);
player-&gt;addComponent(luaComponent);
</code></pre>

<pre><code class="lua">-- player.lua

local player = {
    onEnter = function(self)
        -- do some things in onEnter
    end,

    onExit = function(self)
        -- do some things in onExit
    end,

    update = function(self)
        -- do some things every frame
    end
}

-- it is needed to return player to let c++ nodes know it
return player
</code></pre>

<p>Example with JavaScript:</p>
<pre><code class="cpp">// create a Sprite and add a LUA component
auto player = Sprite::create(&quot;player.png&quot;);

auto jsComponent = ComponentJS::create(&quot;player.js&quot;);
player-&gt;addComponent(jsComponent);
</code></pre>

<pre><code class="javascript">// player.js
Player = cc.ComponentJS.extend({
    generateProjectile: function (x, y) {
        var projectile = new cc.Sprite(&quot;components/Projectile.png&quot;, cc.rect(0, 0, 20, 20));
        var scriptComponent = new cc.ComponentJS(&quot;src/ComponentTest/projectile.js&quot;);
        projectile.addComponent(scriptComponent);
        this.getOwner().getParent().addChild(projectile);

        // set position
        var winSize = cc.director.getVisibleSize();
        var visibleOrigin = cc.director.getVisibleOrigin();
        projectile.setPosition(cc.p(visibleOrigin.x + 20, visibleOrigin.y + winSize.height/2));

        // run action
        var posX = projectile.getPositionX();
        var posY = projectile.getPositionY();
        var offX = x - posX;
        var offY = y - posY;

        if (offX &lt;= 0) {
            return;
        }

        var contentSize = projectile.getContentSize();
        var realX = visibleOrigin.x + winSize.width + contentSize.width/2;
        var ratio = offY / offX;
        var realY = (realX * ratio) + posY;
        var realDest = cc.p(realX, realY);

        var offRealX = realX - posX;
        var offRealY = realY - posY;
        var length = Math.sqrt((offRealX * offRealX) + (offRealY * offRealY));
        var velocity = 960;
        var realMoveDuration = length / velocity;

        projectile.runAction(cc.moveTo(realMoveDuration, realDest));
    },

    onEnter: function() {
        var owner = this.getOwner();
        owner.playerComponent = this;
        cc.eventManager.addListener({
            event: cc.EventListener.TOUCH_ALL_AT_ONCE,
            onTouchesEnded: function (touches, event) {
                var target = event.getCurrentTarget();
                if (target.playerComponent) {
                    var location = touches[0].getLocation();
                    target.playerComponent.generateProjectile(location.x, location.y);
                    jsb.AudioEngine.play2d(&quot;pew-pew-lei.wav&quot;);
                }
            }
        }, owner);
    }
});
</code></pre>

<p>One difference to keep in mind, between JavaScript and LUA components, is you
should return the <strong>object</strong> in LUA component, in JavaScript, you only have to
extend <code>cc.ComponentJS</code></p>
<p>For more detailed usage, please refer to tests projects: <code>tests/lua-tests/src/ComponentTest</code> and
<code>tests/js-tests/src/ComponentTest</code>.</p>
<!--# Chapter 10: Lua

This chapter and its content are currently undecided. If you wish to contribute,
please provide a [Pull Request](https://github.com/chukong/programmers-guide)

## Call custom c++ from Lua
Cocos2d-x lua binds c++ classes, class functions, enums and some global functions
to lua by using the bindings-generator (tools/bindings-generator) and by manual
bindings. This allows you to call custom c++ from lua conveniently.

### Call the class member function

Open `lua-empty-test/src/hello.lua` and you will see many function calls
like `cc.***`. They are actually calling the class member functions. This is the
`initGLView` function:

wzxhzdk:4


The relationship between lua function call and the c++ function call as follow:

wzxhzdk:5


From this table, we can see that the functions called in lua are very similar
with the functions called in c++. These are some key points that we need to pay
attention to:

- `cc` is a module name like namespace name in c++,it is Cocos2d-x 3.0 new
features. The relation between lua modules and c++ namespaces is as follow:

wzxhzdk:6


- static and non-static c++ functions are called in lua using `:`
- `cc.ResolutionPolicy.NO_BORDER` corresponds to `ResolutionPolicy::NO_BORDER`
which is enum value in the c++. `enum` values are bound to lua by manual.
Different modules use different lua files to keep the bindings value:

wzxhzdk:7

- For some functions, their parameters include cocos2d::Vec2, cocos2d::Vec3
we should do a conversion to call c++ function.For example:


wzxhzdk:8


In c++, we should call this function like this:


wzxhzdk:9


In lua, we should call the function like this:


wzxhzdk:10


`cc.p(0.0, 0.0)` is to construct an anonymous table like this {x = 0, y =0}

The other parametric types that should be converted are:


wzxhzdk:11


### Call global functions
Cocos2d-x v3 also binds some global functions to lua manually, such as
`kmGLPushMatrix`, `kmGLTranslatef` and `kmGLLoadMatrix`. We can call these global
functions in lua as follows:

wzxhzdk:12


### Call OpenGL functions
Cocos2d-x v3 binds some OpenGL functions to lua. All the OpenGL functions are in
the `gl` module and can be called as follows:

wzxhzdk:13


You can refer to `lua-tests/DrawPrimitiveTest` and `lua-tests/OpenGLTest` for
more information.


## Bind a c++ class to lua by bindings-generator automatically
Since Cocos2d-x v3.0, there is a tools called [bindings-generator](https://github.com/cocos2d/bindings-generator) to bind c++ class to lua automatically.

The _bindings-generator_ is based on _tolua++_. There is an _ini_ file in the
`tools/tolua` directory and then run the _genbindings.py_ script to generate the
binding code.

### Create a custom class
Consider this code:

wzxhzdk:14


Note:
- the cpp file was omitted  because the bindings-generator only scan the
header files
- The custom class should be inherited from the `Ref` class, this is mainly
due to the destructor of `Ref` calling `removeScriptObjectByObject` to
reduce the reference count of _userdata_ which gets created in the c++
automatically to avoid memory leak.

### Add a new cocos2dx_custom.ini file

In _tools/lua_ folder create a new file named _cocos2dx_custom.ini_ as:


wzxhzdk:15


All of the config files under _tools/tolua_ use the same format. Here is a list
which you should consult when writing your own ini file:

- [title]: To config the title which will by used by the *tools/tolua/gengindings.py*
scripts. Generally, the title could be the file name.
- prefix: To config the prefix of a function name, generally, we also use the
file name as the prefix.
- target_namespace: To config the module name in lua. Here we use the `cc`
as the module name, when you want to use `CustomClass` in lua, you must put
a prefix named `cc` in front of the name. For example, the `CustomClass` could be
reference as `cc.CustomClass`.
- headers: To config all the header files needed for parsing and the %(cocosdir)s
is the engine root path of Cocos2d-x.
- classes: To config all the classes needed to bind. Here it supports regular
expression. So we could set MyCustomClass.* here. For looking more specified usage,
you could ref to `tools/tolua/cocos2dx.ini`.
- skip: To config the functions needed to be omit. Now the bindings-generator can't
parse `void*` type and also the delegate type, so these types needed to be bind
manually. And at this circumstance, you should omit all these types first and
then to bind them manually. You could ref to the config files under path
`cocos/scripting/lua-bindings/auto` .

- rename_functions: To config the functions need to be renamed in the scripting
layer. Due to some reasons, developers want more scripting friendly API, so the
config option is for this purpose.

- rename_classes: Not used any more.

- remove_prefix: Not used any more.

- classes_have_no_parents: To config  the parent class needed to be filter. This
option is seldom modified.

- abstract_classes: To config the classes whose public constructor don't need to
be exported.

- script_control_cpp:yes.  To config whether the scripting layer manage the object
life time or not. If no, then the c++ layer cares about their life time.
Now, it is imperfect to control native object's life time in scripting layer. So
you could simply leave it to *no*.

## Subclassing
Sometimes we want to add some new functions to extend the bindings, think
inheritance in c++. Through `class(classname, super)` function in the `cocos/scripting/lua-bindings/script/cocos2d/extern.lua`, we can realize this
requirement easily. The details function are as follow:


wzxhzdk:16


Through this function, we can see inheritance easily. Example, if we want to
derive from `cc.Node`:

1. Define a subclass by `class` function


wzxhzdk:17


2. Create an object of subclass and use it:

wzxhzdk:18


Note: `new` is implemented by default in the `class` function. Since the type of the
second parameter is `function`, when we call `new`, this is what happens:

wzxhzdk:19


The object created by `new` have all the properties and behaviors of the
`cc.Node` object. It also has the properties of the `SubNode` as it is derived
from `cc.Node`:

wzxhzdk:20


If we still need to call the function of the same name of super class:


wzxhzdk:21

- The override functions of inherited class in lua can't be called in the c++.


## Memory Management

Cocos2d-x v3.x uses the memory management and garbage collection of lua itself
except the release of `userdata`. If the corresponding classes are derived from
`Ref` the release of `userdata` is managed in c++ by the register table named
`toluafix_refid_ptr_mapping` and `tolua_value_root`.

### Simple Test Case
1. Create a `Sprite` in the head of `createDog` function

wzxhzdk:22


2. Then call the `Sprite` in the `tick` function as follow:

wzxhzdk:23


3. After a period of time, we will see the error message as follows:

wzxhzdk:24

This error is triggered because the _testsprite_ didn't add any other node
as a child after creation. The corresponding c++ object was released at the end
of the frame.

### Memory Management for Class Object

#### The Class Members of Ref Class for Memory Management

In `CCRef.h` we see the usage of `CC_ENABLE_SCRIPT_BINDING`:

wzxhzdk:25

Notice `_ID` and `_luaID`, are very important when you push a `Ref` object to lua
by calling `toluafix_pushusertype_ccobject` to store a key-value table named
`toluafix_refid_ptr_mapping` in the registry. The `_ID` is key and the related
c++ object pointer is value. The related code fragment in the
`toluafix_pushusertype_ccobject` is:

wzxhzdk:26

Notes:
- `TOLUA_REFID_PTR_MAPPING` is macro definition represent for "toluafix_refid_ptr_mapping"
- `LUA_REGISTRYINDEX` is definition of `Pseudo-Index` for registry of Lua
- `refid` is value of `_ID`
- `vPtr` is value of related c++ object pointer

#### Create a Ref object from Lua
- Call the `cocos2d::Sprite::create("res/land.png")` by lua bindings to
create a Sprite object and push it into lua stack:

wzxhzdk:27


- Call `toluafix_pushusertype_ccobject` when push created object to lua stack


wzxhzdk:28


In the `toluafix_pushusertype_ccobject` , we will use two tables named
"toluafix_refid_ptr_mapping" and "toluafix_refid_type_mapping" in lua's
registry to store the two key-value pairs about `_ID`-`object pointer` and
`_ID`-`object type name`.The details are as follow:


wzxhzdk:29


- Call `tolua_pushusertype_internal` to determine whether to create a new
userdata, or just update the userdata.


wzxhzdk:30

We use a table named `ubox` to store key-value pairs about `userdata` and
`object pointer`. This table would be used in the destruction of the object.

- Call `tolua_add_value_to_root` to add a reference count for `userdata` in lua
by the `tolua_value_root` table in lua registry. The mechanism will make the
object in lua wouldn't collected by lua gc. Example:

wzxhzdk:31

This code creates a `node` object and extends the attributes of the node object
dynamically by lua's feature. When we want to get this node and its extended
attribute somewhere, we can do as follows:

wzxhzdk:32


If we don't call the `tolua_add_value_to_root`, the result of
`print(child.extendValue)` would be uncertain. Sometimes the result would be
10000 and sometimes it would be `nil`. This is because we wouldn't control lua's
automatic gc effectively. When lua gc thinks there are no other
references for this userdata it will collect this userdata. When we call
`getChildByTag` to get a node object, it would create a new userdata and the
extended attributes would disapper. We add a reference count for the userdata
`tolua_value_root` table in lua registry in the c++ to avoid generating this error.

#### The Release of the Userdata

When calling the desturctor of `Ref`, it will trigger the release of the userdata.

In the destructor of Ref, we can see:

wzxhzdk:33

After we push a c++ object to lua, the related _luaID would be not 0. We now can
call `removeScriptObjectByObject`

The `removeScriptObjectByObject` called would trigger the call of
`toluafix_remove_ccobject_by_refid`, and this function would call some lua c
APIs to operate the table like `toluafix_refid_ptr_mapping`,
`toluafix_refid_type_mapping` and `tolua_value_root` table in the registry.

The specific implementation of `toluafix_remove_ccobject_by_refid` is as follows:

wzxhzdk:34


The steps are as follows:

- Get related object pointer stored in the `toluafix_refid_ptr_mapping` table by
the value of `_luaID`. Store it.

- Remove reference relationship of the object pointer from
`toluafix_refid_ptr_mapping` table by `_luID`

- Get related type name stored in the `tolua_refid_type_mapping` table by the
value of `_luaID`,then store it

- Remove reference relationship of type name from `tolua_refid_type_mapping`
table by `_luID`

- Get the related metatable by the type name

- Get the `ubox` table

- Remove reference relationship of userdata from `tolua_value_root` table by
the object pointer got in the upper step

- Clean userdata and remove reference relationship of userdata from `ubox` by
the object pointer got in the upper step.Note:To destroy an object cited by lua,
we only called '*ud = NULL;'

Through the above steps,the refernce relationships in the
`toluafix_refid_ptr_mapping`,`tolua_refid_type_mapping` and
`tolua_refid_type_mapping` table in the registry would be removed, release the
`userdata` which is created when push c++ object to lua stack, and when lua gc
trigger, the related object would be collected if there is no other place refer
to it.

### Memory Management for Lua Callback Function

Cocos2dx have been used `toluafix_refid_function_mapping` table in the registry
to manage the gc of lua callback function

#### Add a reference for Lua Callback Function
When we define a lua function which would be called throuch c++ codes, we whould
store the pointer of this function in the `toluafix_refid_function_mapping` table
by calling `toluafix_ref_function` function in the `tolua_fix.cpp`.Cocos2d-x bound
a series of functions like `registerScriptHandler` and `addEventListener` to
finish this work.

Let's use `registerScriptHandler` of `Node` as a sample,we could use it as follows
in lua:


wzxhzdk:35


The related bindings function is named `tolua_cocos2d_Node_registerScriptHandler`
in the `lua_cocos2dx_manual.cpp`,the most important sections are as follows:


wzxhzdk:36


- `toluafix_ref_function` is implemented to store the related function pointer
into `toluafix_refid_function_mapping` table in the registry with a static
variable named `s_function_ref_id`.This operation makes lua function avoid being
collected by lua gc because that `toluafix_refid_function_mapping` table have a
reference of this function. The details are as follow:


wzxhzdk:37


- `addObjectHandler` is used to stored the map of object pointer and pair of
`s_function_ref_id` and handler type.

#### Remove a reference for Lua Callback Function
If lua callback function become useless, we should remove the reference in the
`toluafix_refid_function_mapping` table in the registry. Cocos2d-x provided the
`toluafix_remove_function_by_refid` function to realize it. This function could
be called by `removeScriptHandler` of `LuaStack`,`removeScriptHandler` of
`LuaEngine` or directly. The details are as follows:


wzxhzdk:38


Note:
- `refid` is the corresponding value of `s_function_ref_id`.
-  For Ref object,we would call
`ScriptHandlerMgr::getInstance()->removeObjectAllHandlers` to remove all the
reference function relationship which added by the
`ScriptHandlerMgr::getInstance()->addObjectHandler` automatically
-  Because Cocos2d-x v3.x support the features of c++ 11, we can call the related
remove function through the lambda function. For example:


wzxhzdk:39


By the mechanism of the lambda, we could get the value of handler which represents
the corresponding value of `s_function_ref_id`. When we finish calling lua callback
function,we could call `LuaEngine::getInstance()->removeScriptHandler(handler)`
directly to remove the reference of lua callback function.


## Use Cocos Code IDE to Debug a Lua Game
Cocos Code IDE is tool that can debug a lua script,it has windows and mac version.
You can debug Windows and Android lua games through the windows version and you
can debug Mac, iOS and android lua games through the Mac version.
Now we will demonstrate how to use Cocos Code IDE to debug a lua game based on
the mac version. The process of the windows version is almost the same.

## Prerequisite
If you have been not installed the Cocos Code IDE,you can refer to
[Cocos Code IDE Installation](http://www.Cocos2d-x.org/wiki/Cocos_Code_IDE).

## Cocos Code IDE Configuration

### Basic Settings
Click `Cocos Code IDE/Preferences` to open the configuration dialog,then select
the `Cocos/Lua` to set the directory of Cocos2d-x v3.x in the `Lua Frameworks`:

![](10-img/lua_cocos_preferences.png)

### Additional Settings
You should set directory of some compliling tools about android if you need to
replace the Android runtime which Cocos Code IDE provided. Click
`Cocos Code IDE/Preferences` then pitch on `Cocos` to configurate the directory
of related tools:

![](10-img/cocos_preferences.png)

## Debug a Lua Game
1. Create a new Cocos Lua Project by the right click menu in the
`Lua Projects Explorer`

![](10-img/lua_create_project.png)

2. Select `src/GameScene.lua` and open it,then toggle breakpoint by right click
menu or double click

![](10-img/lua_toggle_breakpoint.png)

3.Click debug button on toolbar

![](10-img/lua_debug_button.png)

4.Trigger the breakpoint,select "Yes" to open `Debug Perspective`,and you will
find many useful debug views like `Call stacks`, `Variables` and `Breakpoints`,etc.

![](10-img/lua_confirm_perspective.png)
![](10-img/lua_debug_dialog.png)

5.Use `Step over`, `Step into`, `Step out` in the tool bar to debug

![](10-img/lua_step_debug.png)

## Code Hot Updating when Debugging
We could realize the hot updating of lua code when debugging by the Cocos Code IDE.

If you want to change the moving path of dog int the src/GameScene.lua, you can
modify the "tick()" function to control the dog's position


wzxhzdk:40


Modify the implementation of function, for example, change the value 1 to 10 and
save your change. Then you will find that you have improved the speed of
SpriteDog without restarting the app!

## How to Debug on the Other Target Platforms
The above example is executed on the Mac platform because of the default
configuration of Cocos Code IDE.If you debug on the other target platforms you
should modify `Debug Configurations`.

1. Click `Debug Configurations` button on the toolbar to open
`Debug Configurations` dialog

![](10-img/lua_config_button.png)

2. Select the `CocosLuaGame` item,then to configure
![](10-img/lua_debug_configure_dialog.png)

### Debug on the iOS Simulator
1. Check iOS Simulator radio button

2. Choose a runtime app

3. Click the Debug button,IDE will auto-install chosen runtime app and start
runtime to debug

![](10-img/lua_configure_iOS_simulator.png)

### Debug on an iOS Device

1.You need a runtime IPA, you can build a custom runtime IPA by Cocos Code IDE,
then [install runtime IPA](http://www.solutionanalysts.com/blog/how-install-ipa-file-iphone-ipod-ipad-using-itunes-mac-windows)
to iOS device.

  - Click `Build Runtime` on the toolbars

  ![](10-img/lua_configure_build_runtime.png)

  - Click `Yes` button on the pop-up `Cocos` dialog

  ![](10-img/lua_configure_build_runtime_first.png)

  - Click `Generate` button to Generate `Create Native Source Wizard`

  ![](10-img/lua_configure_creat_native_source_wizard.png)

  - Click `Close` button to finish `Create Native Source Wizard`

  ![](10-img/lua_configure_finish_create_native_source_wizard.png)

  - Click `Build Runtime` on the toolbars to open `Runtime Builder Wizard` dialog

  ![](10-img/lua_configure_runtime_builder_wizard.png)

  - Check `Build iOS Device Runtime` and click `Generate` button to generate

  ![](10-img/lua_configure_runtime_select_iOS_device.png)

  - Click `Close` button when Finished dialog pop up

  ![](10-img/lua_configure_finish_iOS_device.png)

2. Click `Debug Configuration`,then check `Remote Debug` radio button on the
`Debug Configuration` dialog
3. Select `iOS` platform
4. Fill IP address of your device into the `Target IP` and Fill the IP address
that your PC used on the `Host IP`(Make sure that the `Target IP` and `Host IP`
can access each other)
5. Click 'Debug' button to begin to debug

  ![](10-img/lua_iOS_device_remote_setting.png)

### Debug on Android Device by ADB Mode
1. Prebuild Runtimelua.apk by `Build Runtime` like first of `Debug on the iOS Device`
2. Check `Android ADB Mode` radio button
3. Choose a runtime apk
4. Click the `Debug` button
5. IDE will auto-install the chosen runtime apk and start to debug

![](10-img/lua_debug_android_adb_mode.png)


### Debug on Android Device by WLAN

1. Install runtime apk to your device manually. It is placed in CocosLuaGame/runtime/android.
2. Start runtime on device manually
3. Click `Debug Configuration`,then check `Remote Debug` radio button on the
`Debug Configuration` dialog
4. Fill IP address of your device into the `Target IP` and Fill the IP address
that your PC used on the `Host IP`(Make sure that the `Target IP` and `Host IP`
can access each other)
5. Click 'Debug' button to begin to debug

![](10-img/lua_anroid_device_remote_setting.png)
-->

<!-- previous/next buttons for everything but the home page -->

<ul class="nav navbar-nav navbar-right">
    
        <li >
            <a rel="next" href="../3d/index.html">
                <i class="fa fa-arrow-left"></i> Previous
            </a>
        </li>
        <li >
            <a rel="prev" href="../physics/index.html">
                Next <i class="fa fa-arrow-right"></i>
            </a>
        </li>
    
</ul>
</div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
                <p style="text-align:center">Copyright (c) 2014-2016 Chukong Technologies Inc.</p>
            
           <!-- <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>-->
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>

        <!-- PG languages -->
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
        <script>
        $(function() {
          var key = "Cocos2d-x_pg_lang";
          var switch_lang = function(l) {
              $('.langs li a').removeClass('selected');
              $('#'+l).addClass('selected');
              $('.tab_content').hide();
              $('.'+l).show();
              $.cookie(key, l);
          }
          $('.langs li a').click(function() {switch_lang(this.id);return false;});
          var c = $.cookie(key);
          if (typeof c == 'undefined') c='tab-cpp';
          switch_lang(c);
        });
        </script>

        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../tutorials/javascript/parkour-game-with-javascript/Cocos2d-html5-min.js"></script>
        <script src="../../tutorials/javascript/parkour-game-with-javascript/chipmunk.js"></script>
        <script src="../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/cocos2d-jsb.js"></script>
        <script src="../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/cocos2d.js"></script>
        <script src="../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/main.js"></script>
        <script src="../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/AnimationLayer.js"></script>
        <script src="../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/BackgroundLayer.js"></script>
        <script src="../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/Coin.js"></script>
        <script src="../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/GameOverLayer.js"></script>
        <script src="../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/PlayScene.js"></script>
        <script src="../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/Rock.js"></script>
        <script src="../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/SimpleRecognizer.js"></script>
        <script src="../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/StatusLayer.js"></script>
        <script src="../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/globals.js"></script>
        <script src="../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/myApp.js"></script>
        <script src="../../tutorials/javascript/parkour-game-with-javascript/chapter10/code/src/resource.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
